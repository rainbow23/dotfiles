# fzf.sh 修正に関する Q&A

## Q1: `clear` と `tput reset` の違い

| | `clear` | `tput reset` |
|---|---|---|
| 画面クリア | する | する |
| カーソル位置リセット | する | する |
| ターミナル属性リセット | **しない** | **する** |
| スクロール領域リセット | **しない** | **する** |

`clear` は画面を消すだけなので、fzf が設定したターミナル属性（カーソル非表示、スクロール領域の変更など）が残ったまま次の fzf が起動し、繰り返すほど状態が蓄積して描画が壊れる。
`tput reset` はターミナルを初期状態に戻すので、この蓄積が起きない。

---

## Q2: `[[ -n "$_target_branch" ]]` は何をチェックしているか

文字列が**空でないこと**を確認している。

```zsh
if [ "$q" = enter ] && [[ -n "$_target_branch" ]] ; then
```

| テスト | 意味 |
|---|---|
| `-n "$var"` | 文字列が空でない（長さが1以上） |
| `-z "$var"` | 文字列が空（長さが0） |

修正前のコードにはこのチェックがなかったため、ブランチを選択せずに Enter を押した場合でも `git-commit-show` が呼ばれていた。このガード条件で空のブランチ名が渡されるのを防いでいる。

---

## Q3: `${1:+$1}` と `${1:+"$1"}` の違い

| 記法 | 引数にスペースがある場合 |
|---|---|
| `${1:+$1}` | 単語分割される可能性がある |
| `${1:+"$1"}` | 1つの引数として保持される |

ブランチ名にスペースは通常ないが、安全のためクォート付き `${1:+"$1"}` に統一した。

---

## Q4: `${1:+"$1"}` はzsh固有か

POSIX標準のパラメータ展開であり、bash/zsh/sh すべてで使える。

POSIX標準のパラメータ展開一覧：

| 記法 | 意味 |
|---|---|
| `${var:-word}` | 未設定or空なら `word` を使う |
| `${var:=word}` | 未設定or空なら `word` を代入 |
| `${var:+word}` | 値があれば `word` を使う |
| `${var:?word}` | 未設定or空ならエラー |

---

## Q5: `${1:+"$1"}` の git log への反映結果

### `${1:+"$1"}` を使用した場合

| `$1` の状態 | `${1:+"$1"}` の展開 | 実行されるコマンド | 結果 |
|---|---|---|---|
| 未設定 | *何も展開しない* | `git log --graph --color=always --format=...` | カレントブランチのログを表示 |
| 空文字 `""` | *何も展開しない* | `git log --graph --color=always --format=...` | カレントブランチのログを表示 |
| `"main"` | `"main"` | `git log --graph --color=always "main" --format=...` | main ブランチのログを表示 |

### `"$1"` だけの場合（比較）

| `$1` の状態 | `"$1"` の展開 | 実行されるコマンド | 結果 |
|---|---|---|---|
| 未設定 | `""` | `git log --graph --color=always "" --format=...` | 空文字列がrefとして解釈されエラー |
| 空文字 `""` | `""` | `git log --graph --color=always "" --format=...` | 同上 |
| `"main"` | `"main"` | `git log --graph --color=always "main" --format=...` | main ブランチのログを表示 |

ポイントは、`${1:+"$1"}` は未設定・空文字の場合に**引数自体を消す**のに対し、`"$1"` は**空文字列 `""` を引数として渡してしまう**点。

---

## Q6: `${1:+"$1"}` の `1` は何を指すか

`1` は変数名ではなく、**位置パラメータ**（関数の引数）を指す。

```zsh
my_func() {
  echo $1    # 第1引数
  echo $2    # 第2引数
  echo $3    # 第3引数
}

my_func "aaa" "bbb" "ccc"
# $1 = "aaa", $2 = "bbb", $3 = "ccc"
```

`${1:+"$1"}` の構造：

```
${  1  :+  "$1"  }
 変数  演算子  展開値
```

| 部分 | 対応 | 意味 |
|---|---|---|
| `1` | `var` | 位置パラメータ `$1`（第1引数） |
| `:+` | `:+` | 「値があれば」の演算子 |
| `"$1"` | `word` | 展開する値（クォート付きの `$1`） |

`:` は演算子 `:+` の一部であり、`1:` という区切りではない。

通常の変数でも同様：

```zsh
branch="main"
echo ${branch:+"$branch"}   # → "main"

branch=""
echo ${branch:+"$branch"}   # → (何も出力しない)
```
